// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int            @id @default(autoincrement())
  name         String
  email        String         @unique
  phone        String
  accessCode   String         @unique
  role         String         @default("user") // "user" or "admin"
  password     String?        // For admin login
  createdAt    DateTime       @default(now())
  registrations Registration[]
}

model RaceCategory {
  id           Int            @id @default(autoincrement())
  name         String         @unique // "5km", "10km", "20km"
  price        Decimal        @db.Decimal(10, 2)
  participants Participant[]
  qrCodes      QrCode[]
}

model JerseyOption {
  id           Int            @id @default(autoincrement())
  size         String         @unique // "XS", "S", "M", "L", "XL", "XXL"
  price        Decimal        @db.Decimal(10, 2)
  quantity     Int
  participants Participant[]
}

model Registration {
  id               Int            @id @default(autoincrement())
  userId           Int
  user             User           @relation(fields: [userId], references: [id])
  registrationType String         // "individual" or "community"
  groupName        String?        // for community
  totalAmount      Decimal        @db.Decimal(10, 2)     // required Decimal (API sets this)
  paymentStatus    String         @default("pending") // "pending", "confirmed", "rejected"
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  participants     Participant[]
  payments         Payment[]
  qrCodes          QrCode[]
}

model Participant {
  id               Int            @id @default(autoincrement())
  registrationId   Int
  registration     Registration   @relation(fields: [registrationId], references: [id])
  categoryId       Int
  category         RaceCategory   @relation(fields: [categoryId], references: [id])
  jerseyId         Int
  jersey           JerseyOption   @relation(fields: [jerseyId], references: [id])
  bibNumber        String?
  packClaimed      Boolean        @default(false)
  claimDetails     ClaimDetail[]
}

model Payment {
  id               Int            @id @default(autoincrement())
  registrationId   Int
  registration     Registration   @relation(fields: [registrationId], references: [id])
  transactionId    String         @unique
  proofOfPayment   String
  status           String         @default("pending")
  paidAt           DateTime?      // make nullable
  amount           Decimal?       @db.Decimal(10, 2)
  createdAt        DateTime       @default(now())
}

model QrCode {
  id               Int            @id @default(autoincrement())
  registrationId   Int
  registration     Registration   @relation(fields: [registrationId], references: [id])
  categoryId       Int
  category         RaceCategory   @relation(fields: [categoryId], references: [id])
  qrCodeData       String         @unique
  totalPacks       Int            // number of participants in this category
  maxScans         Int            // totalPacks + 3
  scansRemaining   Int            // decrements on each scan
  createdAt        DateTime       @default(now())
  claims           RacePackClaim[]
}

model RacePackClaim {
  id                  Int            @id @default(autoincrement())
  qrCodeId            Int
  qrCode              QrCode         @relation(fields: [qrCodeId], references: [id])
  claimedBy           String
  packsClaimedCount   Int
  claimedAt           DateTime       @default(now())
  claimDetails        ClaimDetail[]
}

model ClaimDetail {
  id               Int            @id @default(autoincrement())
  claimId          Int
  participantId    Int
  participant      Participant    @relation(fields: [participantId], references: [id])
  claim            RacePackClaim  @relation(fields: [claimId], references: [id])
}